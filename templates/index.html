<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Parser</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">

<header>
    <h1>Telegram Parser</h1>
    <p class="subtitle">Search ¬∑ Check ¬∑ Sort</p>
</header>

<!-- TELEGRAM AUTH -->
<div class="card" id="tg-auth" style="display:none;">
    <div class="card-title">Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>

    <!-- STEP 1 -->
    <div id="tg-step-phone">
        <div class="parser-grid-2">
            <input class="setup-input" id="api_id" placeholder="API ID">
            <input class="setup-input" id="api_hash" placeholder="API HASH">
        </div>
        <input class="setup-input" id="phone" placeholder="+79998887766">
        <div class="toolbar">
            <button class="tool-btn" onclick="sendCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
        </div>
    </div>

    <hr>

    <!-- STEP 2 -->
    <div id="tg-step-code" style="display:none;">
        <div class="parser-grid-2">
            <input class="setup-input" id="code" placeholder="–ö–æ–¥ –∏–∑ Telegram">
            <input class="setup-input" id="password" placeholder="2FA –ø–∞—Ä–æ–ª—å">
        </div>
        <div class="toolbar">
            <button class="tool-btn" onclick="confirmCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- SEARCH -->
<div class="card">
    <div class="card-title">–ü–æ–∏—Å–∫</div>

    <form id="run-form">
        <textarea name="queries" class="setup-input" rows="4"
                  placeholder="—à–∫–æ–ª–∞&#10;–∫–µ–π–ø–æ–ø"></textarea>

        <div class="toolbar">
            <button class="tool-btn" >‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <a href="/export/excel" class="tool-btn">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
            <button class="tool-btn" onclick="recheckEmpty()" type="button">üîÑ –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—É—Å—Ç—ã–µ</button>
            <button class="tool-btn danger" onclick="clearResults()" type="button">üóë –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            <div style="margin-left:auto;">
                –°—Ç–∞—Ç—É—Å:
                <span id="status">{{ progress.done }} / {{ progress.total }}</span>
            </div>
        </div>
    </form>

    <pre id="log" class="analysis"></pre>
</div>

<!-- RESULTS -->
<div class="card">
    <div class="card-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
    <table class="parser-table" id="resultTable">
        <thead>
        <tr>
            <th>@</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</th><th>–¢–∏–ø</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</div>

<script>
const wsock = new WebSocket(`ws://${location.host}/ws`);

wsock.onmessage = (e) => {
    const d = JSON.parse(e.data);

    document.getElementById("status").textContent =
        `${d.progress.done} / ${d.progress.total}`;

    document.getElementById("log").textContent =
        d.log.join("\n");

    const tg = document.getElementById("tg-auth");
    const stepPhone = document.getElementById("tg-step-phone");
    const stepCode = document.getElementById("tg-step-code");

    if (d.telegram_ready) {
        tg.style.display = "none";
    } else {
        tg.style.display = "block";
        stepPhone.style.display = d.telegram_code_sent ? "none" : "block";
        stepCode.style.display = d.telegram_code_sent ? "block" : "none";
    }

    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";
    for (const r of d.rows || []) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><a href="${r[1]}" target="_blank">@${r[0]}</a></td>
            <td>${r[2] || "‚Äî"}</td>
            <td>${r[3]}</td>
            <td>${r[4]}</td>
        `;
        tbody.appendChild(tr);
    }
};

async function sendCode() {
    const f = new FormData();
    f.append("api_id", api_id.value);
    f.append("api_hash", api_hash.value);
    f.append("phone", phone.value);
    await fetch("/tg/send_code", { method:"POST", body:f });
}

async function confirmCode() {
    const f = new FormData();
    f.append("code", code.value);
    f.append("password", password.value);

    const r = await fetch("/tg/confirm", { method:"POST", body:f });
    if (!r.ok) {
        const e = await r.json();
        if (e.detail === "CODE_EXPIRED") {
            alert("–ö–æ–¥ –∏—Å—Ç—ë–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π.");
        } else if (e.detail === "CODE_INVALID") {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥.");
        }
    }
}

async function recheckEmpty() {
    await fetch("/recheck_empty", { method: "POST" });
}

document.getElementById("run-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const fd = new FormData(form);

    await fetch("/run", {
        method: "POST",
        body: fd
    });
});

async function clearResults() {
    if (!confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?")) return;
    await fetch("/clear_results", { method: "POST" });
}
</script>

</body>
</html>
